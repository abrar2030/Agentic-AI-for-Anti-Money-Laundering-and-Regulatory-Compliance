name: CI Formatting Check

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]
  workflow_dispatch:

jobs:
  formatting_check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python formatters
        run: |
          python -m pip install --upgrade pip
          pip install autoflake black

      - name: Run autoflake (dry-check + list affected files)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Preparing temporary copy of repository for autoflake ==="
          TMP_COPY="$(mktemp -d)"
          rsync -a --exclude='.git' --exclude='node_modules' --exclude='.venv' ./ "$TMP_COPY/"

          echo "=== Running autoflake (will modify temp copy) on all .py files ==="
          find "$TMP_COPY" -type f -name "*.py" -print0 | xargs -0 --no-run-if-empty autoflake \
            --remove-all-unused-imports \
            --remove-unused-variables \
            --recursive \
            --ignore-init-module-imports \
            --in-place

          echo "=== Showing which files would change (if any) ==="
          # -q only prints names of differing files
          if diff -rq . "$TMP_COPY" > /dev/null; then
            echo "autoflake check: no changes detected."
          else
            echo "autoflake would change the following files:"
            diff -rq . "$TMP_COPY" | sed -n 's/^Files //; s/ and .*//p' || true
            echo
            echo "To fix locally: autoflake --remove-all-unused-imports --remove-unused-variables --recursive --ignore-init-module-imports --in-place <path>"
            rm -rf "$TMP_COPY"
            exit 1
          fi

          rm -rf "$TMP_COPY"
          echo "autoflake check passed (no changes)."

      - name: Run black check (repo-wide)
        run: |
          black . --check

      - name: Set up Node.js (for Prettier checks)
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Node dependencies (root)
        working-directory: .
        run: |
          npm ci

      - name: Run Prettier Checks (all .md files in repo)
        working-directory: .
        run: |
          echo "=== Running Prettier (all .md files) ==="
          npx --no-install prettier --check "**/*.md" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in markdown files across the repo."
            exit 1
          }

      - name: Run Prettier Checks (all .yml/.yaml files in repo)
        working-directory: .
        run: |
          echo "=== Running Prettier (all .yml/.yaml files) ==="
          npx --no-install prettier --check "**/*.{yml,yaml}" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in YAML/YML files."
            exit 1
          }

      - name: Finalize Check
        run: echo "All formatting checks for .py, .md and .yml/.yaml files completed successfully."

  # Optional autofix job â€” run manually from Actions UI (workflow_dispatch)
  autofix:
    needs: []
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install formatters
        run: |
          python -m pip install --upgrade pip
          pip install autoflake black

      - name: Run autoflake + black (apply fixes)
        shell: bash
        run: |
          set -euo pipefail

          # apply autoflake to repo in-place (target only .py files)
          find . -type f -name "*.py" -print0 | xargs -0 --no-run-if-empty autoflake \
            --remove-all-unused-imports \
            --remove-unused-variables \
            --recursive \
            --ignore-init-module-imports \
            --in-place

          # run black to format python code
          black .

          # prepare commit if anything changed
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No formatting changes to commit."
            exit 0
          fi

          git commit -m "chore: apply autoflake + black formatting"

      - name: Create Pull Request with formatting fixes
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: apply autoflake + black formatting"
          branch: "format/autofix-${{ github.run_id }}"
          title: "Auto-format: apply autoflake + black"
          body: |
            This pull request applies autoflake and black formatting to Python files.
            If this change looks good, please merge it into your target branch.
