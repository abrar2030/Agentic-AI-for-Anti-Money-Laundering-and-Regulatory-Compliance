name: CI Formatting Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  formatting_check:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------
      # Checkout repository
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -------------------------------
      # Python Setup + Caching
      # -------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python formatters
        run: pip install --upgrade pip && pip install autoflake black

      # -------------------------------
      # Run Python formatting checks (backend only)
      # -------------------------------
      - name: Run Python formatting checks (backend)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Preparing temporary copy of repository for autoflake ==="
          TMP_COPY="$(mktemp -d)"
          cp -a . "$TMP_COPY/"

          echo "=== Running autoflake (will modify temp copy) ==="
          autoflake \
            --remove-all-unused-imports \
            --remove-unused-variables \
            --recursive \
            --ignore-init-module-imports \
            --in-place \
            "$TMP_COPY"

          echo "=== Comparing repository with autoflake-modified copy ==="
          if ! diff -r . "$TMP_COPY" > /dev/null; then
            echo "autoflake found formatting/unused-imports issues in Python files."
            echo "Run: autoflake --remove-all-unused-imports --remove-unused-variables --recursive --ignore-init-module-imports --in-place ."
            rm -rf "$TMP_COPY"
            exit 1
          fi

          rm -rf "$TMP_COPY"

          echo "=== Running black (check mode) ==="
          black --check .

      # -------------------------------
      # Node + npm caching
      # -------------------------------
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install Node dependencies (root)
        working-directory: .
        run: |
          npm ci

      # -------------------------------
      # Prettier checks
      # -------------------------------

      # 2) Repository-wide Markdown check (ALL .md files)
      - name: Run Prettier Checks (all .md files in repo)
        working-directory: .
        run: |
          echo "=== Running Prettier (all .md files) ==="
          npx --no-install prettier --check "**/*.md" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in markdown files across the repo."
            exit 1
          }

      # 3) Repository-wide YAML/YML check (ALL yaml/yml files)
      - name: Run Prettier Checks (all YAML/YML files in repo)
        working-directory: .
        run: |
          echo "=== Running Prettier (YAML/YML files) ==="
          npx --no-install prettier --check "**/*.{yml,yaml}" --ignore-path .prettierignore || {
            echo "Prettier formatting issues detected in YAML/YML files."
            exit 1
          }

      # -------------------------------
      # Finalize
      # -------------------------------
      - name: Finalize Check
        run: echo "All formatting checks completed successfully."
